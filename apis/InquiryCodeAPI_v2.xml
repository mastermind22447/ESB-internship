<api xmlns="http://ws.apache.org/ns/synapse" name="InquiryCodeAPI_v2" context="/services/training/v1.0/inquiry/code/v2">
   <resource methods="POST" url-mapping="/">
      <inSequence>
         <!-- Log request -->
         <log level="custom">
            <property name="Step" value="API received request"/>
            <property name="Payload" expression="json-eval($.)"/>
         </log>
         <!-- Iterate referenceCode array -->
         <iterate continueParent="true" expression="json-eval($.referenceCode)" sequential="true" id="RefIterator">
            <target>
               <sequence>
                  <!-- Extract just the number -->
                  <property name="currentRef" expression="json-eval($.)" scope="default" type="STRING"/>
                  <log level="custom">
                     <property name="Step" value="Iterating each referenceCode"/>
                     <property name="CurrentRef" expression="get-property('currentRef')"/>
                  </log>
                  <!-- ============================
     1) POST /rbt/v1.0/id
============================== -->
                  <payloadFactory media-type="json">
                     <format>{ "id": "$1" }</format>
                     <args>
                        <arg expression="get-property('currentRef')"/>
                     </args>
                  </payloadFactory>
                  <property name="messageType" value="application/json" scope="axis2"/>
                  <header name="Authorization" scope="transport" action="set" value="1"/>
                  <log level="custom">
                     <property name="DEBUG_AUTH_HEADER" expression="get-property('transport','Authorization')"/>
                     <property name="Step" value="Calling /id endpoint"/>
                     <property name="PayloadGoingToID" expression="json-eval($.)"/>
                  </log>
                  <call blocking="true">
                     <endpoint key="RbtIDEndpoint"/>
                  </call>
                  <log level="custom">
                     <property name="Step" value="Response from /id endpoint"/>
                     <property name="ResponseFromID" expression="json-eval($.)"/>
                  </log>
                  <!-- Extract code from ID response -->
                  <property name="idResponseCode" expression="json-eval($.code)" scope="default" type="STRING"/>
                  <log level="custom">
                     <property name="ExtractedCode" expression="get-property('idResponseCode')"/>
                  </log>
                  <!-- ============================2) PUT /rbt/v1.0/code============================== -->
                  <payloadFactory media-type="json">
                     <format>{ "code": "$1" }</format>
                     <args>
                        <arg expression="get-property('idResponseCode')"/>
                     </args>
                  </payloadFactory>
                  <property name="messageType" value="application/json" scope="axis2"/>
                  <header name="Authorization" scope="transport" action="set" value="1"/>
                  <property name="HTTP_METHOD" value="PUT" scope="axis2"/>
                  <log level="custom">
                     <property name="Step" value="Calling /code endpoint"/>
                     <property name="PayloadGoingToCODE" expression="json-eval($.)"/>
                  </log>
                  <call blocking="true">
                     <endpoint key="RbtCodeEndpoint"/>
                  </call>
                  <log level="custom">
                     <property name="Step" value="Response from /code endpoint"/>
                     <property name="ResponseFromCODE" expression="json-eval($.)"/>
                  </log>
                  <!-- ============================
     3) POST /rbt/v1.0/cheque
     ⚠️ Uses original ID again
============================== -->
                  <payloadFactory media-type="json">
                     <format>{ "code": "$1" }</format>
                     <args>
                        <arg expression="get-property('currentRef')"/>
                     </args>
                  </payloadFactory>
                  <property name="messageType" value="application/json" scope="axis2"/>
                  <header name="Authorization" scope="transport" action="set" value="1"/>
                  <property name="HTTP_METHOD" value="POST" scope="axis2"/>
                  <log level="custom">
                     <property name="Step" value="Calling /cheque endpoint"/>
                     <property name="PayloadGoingToCHEQUE" expression="json-eval($.)"/>
                  </log>
                  <call blocking="true">
                     <endpoint key="RbtChequeEndpoint"/>
                  </call>
                  <log level="custom">
                     <property name="Step" value="Response from /cheque endpoint"/>
                     <property name="ResponseFromCHEQUE" expression="json-eval($.)"/>
                  </log>
               </sequence>
            </target>
         </iterate>
         <aggregate id="FinalAggregator">
            <completeCondition>
               <messageCount min="1" max="1000"/>
            </completeCondition>
            <onComplete expression="//jsonObject">
               <payloadFactory media-type="json">
                  <format>[ $1 ]</format>
                  <args>
                     <arg evaluator="xml" expression="//jsonObject"/>
                  </args>
               </payloadFactory>
               <respond/>
            </onComplete>
         </aggregate>
      </inSequence>
      <outSequence>
         <respond/>
      </outSequence>
   </resource>
</api>
